# DeSci平台链上写链下读架构设计方案

## 1. 架构概述

### 1.1 设计理念
- **链上存储**：关键数据哈希、状态变更、权限验证
- **链下存储**：完整数据内容、索引信息、查询优化
- **事件驱动**：通过智能合约事件同步链上链下数据
- **数据一致性**：通过哈希校验确保链上链下数据一致性

### 1.2 核心组件
1. **智能合约层**：数据哈希存储、事件发射、权限控制
2. **后端服务层**：事件监听、数据同步、API服务
3. **数据库层**：PostgreSQL存储完整数据
4. **缓存层**：Redis缓存热点数据

## 2. 数据流设计

### 2.1 写入流程（链上写）
1. 用户提交数据到前端
2. 前端调用智能合约写入方法
3. 合约验证数据，计算哈希，存储哈希
4. 合约发射事件（包含完整数据）
5. 后端监听事件，同步到数据库

### 2.2 读取流程（链下读）
1. 前端请求数据
2. 后端从数据库/缓存读取
3. 可选：验证数据哈希一致性
4. 返回数据给前端

## 3. 技术架构

### 3.1 智能合约改造
- 保留核心验证逻辑
- 简化存储结构（只存哈希）
- 增强事件发射（包含完整数据）
- 添加数据验证接口

### 3.2 后端服务架构
```
backend/
├── src/
│   ├── config/          # 配置管理
│   ├── contracts/       # 合约ABI和地址
│   ├── database/        # 数据库模型和连接
│   ├── listeners/       # 区块链事件监听器
│   ├── services/        # 业务逻辑服务
│   ├── controllers/     # API控制器
│   ├── middleware/      # 中间件
│   └── utils/          # 工具函数
├── migrations/         # 数据库迁移文件
└── tests/             # 测试文件
```

### 3.3 数据库设计
```sql
-- 研究数据表
CREATE TABLE research_data (
    id BIGSERIAL PRIMARY KEY,
    token_id BIGINT NOT NULL,
    title VARCHAR(500) NOT NULL,
    description TEXT,
    data_hash VARCHAR(66) NOT NULL,
    ipfs_hash VARCHAR(100),
    author_address VARCHAR(42) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    block_number BIGINT NOT NULL,
    transaction_hash VARCHAR(66) NOT NULL
);

-- 用户档案表
CREATE TABLE user_profiles (
    id BIGSERIAL PRIMARY KEY,
    user_address VARCHAR(42) UNIQUE NOT NULL,
    username VARCHAR(100),
    bio TEXT,
    avatar_url VARCHAR(500),
    research_areas TEXT[],
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 数据集表
CREATE TABLE datasets (
    id BIGSERIAL PRIMARY KEY,
    dataset_id BIGINT NOT NULL,
    name VARCHAR(500) NOT NULL,
    description TEXT,
    category VARCHAR(100),
    data_hash VARCHAR(66) NOT NULL,
    ipfs_hash VARCHAR(100),
    creator_address VARCHAR(42) NOT NULL,
    is_public BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    block_number BIGINT NOT NULL,
    transaction_hash VARCHAR(66) NOT NULL
);
```

## 4. 实现策略

### 4.1 渐进式迁移
1. 保持现有合约功能完整性
2. 新增事件发射功能
3. 并行开发后端服务
4. 前端逐步切换到链下读取

### 4.2 数据一致性保证
1. 事务级别的数据同步
2. 定期数据校验任务
3. 异常恢复机制
4. 数据回滚策略

### 4.3 性能优化
1. 数据库索引优化
2. Redis缓存策略
3. API分页和过滤
4. 连接池管理
